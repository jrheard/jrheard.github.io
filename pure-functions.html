<!DOCTYPE html>
<html lang="en-us">

<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
    Pure Functions &middot; jrheard's blog
    
  </title>

  <link rel="stylesheet" href="/assets/css/codemirror.css?v=2024-08-31 12:48:16 -0700" />
  <link rel="stylesheet" href="/assets/css/poole.css?v=2024-08-31 12:48:16 -0700" />
  <link rel="stylesheet" href="/assets/css/syntax.css?v=2024-08-31 12:48:16 -0700" />
  <link rel="stylesheet" href="/assets/css/lanyon.css?v=2024-08-31 12:48:16 -0700" />
  <link rel="stylesheet" href="/assets/css/asciinema-player.css?v=2024-08-31 12:48:16 -0700" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144"
    href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

</head>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-WPQ6LVYFJM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'G-WPQ6LVYFJM');
</script>



<body class="theme-base-08">

  <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
    
    
    
    
    
    
    
    
    
    
    <a class="sidebar-nav-item" href="/about">About Me</a>
    
    
    
    
    
    
    
    
    
    
    
    <a class="sidebar-nav-item" href="/python/blackjack">Madison CS 3-4: Blackjack</a>
    
    
    
    
    
    <a class="sidebar-nav-item" href="/python/caesar">Madison CS 3-4: Caesar Cipher</a>
    
    
    
    
    
    <a class="sidebar-nav-item" href="/python/guess-my-number">Madison CS 3-4: Guess My Number</a>
    
    
    
    
    
    <a class="sidebar-nav-item" href="/python/mad-libs">Madison CS 3-4: Mad Libs</a>
    
    
    
    
    
    <a class="sidebar-nav-item" href="/python/password-checker">Madison CS 3-4: Password Checker</a>
    
    
    
    
    
    <a class="sidebar-nav-item" href="/python/password-generator">Madison CS 3-4: Password Generator</a>
    
    
    
    
    
    <a class="sidebar-nav-item" href="/python/plotter">Madison CS 3-4: Generated Art with a Pen Plotter</a>
    
    
    
    
    
    <a class="sidebar-nav-item" href="/python/roguelike">Madison CS 3-4: Roguelike</a>
    
    
    
    
    
    <a class="sidebar-nav-item" href="/python/tic-tac-toe">Madison CS 3-4: Tic-Tac-Toe</a>
    
    
    

    <a class="sidebar-nav-item" href="http://github.com/jrheard">GitHub</a>
    <a class="sidebar-nav-item" href="http://twitter.com/jrheard">Twitter</a>
    <a class="sidebar-nav-item" href="/quinto">Quinto</a>
    <a class="sidebar-nav-item" href="/duelyst.html">Duelyst Tool</a>
  </nav>

</div>


  <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
  <div class="wrap">
    <div class="masthead">
      <div class="container">
        <h3 class="masthead-title">
          <a href="/" title="Home">jrheard's blog</a>
          <small></small>
        </h3>
      </div>
    </div>

    <div class="container content">
      
      <div class="post">
	<h1 class="post-title">Pure Functions</h1>
	<span class="post-date">31 Aug 2024</span>
	<p>The hardest problem in software engineering (aside from choosing <em>which program to write</em>) is keeping your program simple enough for maintainers to confidently read, understand, and make changes to. This problem is called “<strong>managing complexity</strong>,” and there are lots of famous quotes about it<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>. Managing complexity is easy when a program is small, but it gets exponentially harder as years pass, the program gets bigger, the engineering organization gets bigger too, and the program’s original authors leave.</p>

<p>Pure functions are <strong>my favorite tool</strong> for managing complexity. Let’s talk about what they are and why they’re so effective. Note: I’ll be showing examples in Python, but you can write pure functions in <strong>any</strong> programming language.</p>

<h2 id="what-is-a-pure-function">What is a pure function?</h2>

<p>We call a function “pure” if it follows these two rules:</p>
<ol>
  <li>It always returns the same outputs when given the same inputs.</li>
  <li>It performs no side effects.</li>
</ol>

<p>Here are some examples of what I mean when I say “side effects”:</p>

<ul>
  <li>Mutating one of the function’s arguments</li>
  <li>Mutating a global variable</li>
  <li>Reading/writing to a database</li>
  <li>Making an HTTP request</li>
  <li>Sending an email</li>
  <li>Sending a push notification</li>
  <li>Firing a missile</li>
</ul>

<h2 id="examples">Examples</h2>

<p>This is a pure function:</p>

<textarea class="hidden">
# Imagine that this `distance_between` library function is also pure.
from some_library import distance_between

def find_closest_scooter(
    scooters: list[Scooter], point: Point
) -&gt; Scooter | None:
    """Returns the closest Scooter to `point`."""
    if not scooters:
        return None

    distances = [
        distance_between(scooter.location, point)
        for scooter in scooters
    ]

    closest_scooter, smallest_distance = min(
        zip(scooters, distances),
        key=lambda scooter, distance: distance
    )

    return closest_scooter
</textarea>
<pre class="cm-s-friendship-bracelet"></pre>

<p>This function is impure:</p>

<textarea class="hidden">
def find_closest_scooter(
    scooters: list[Scooter], point: Point
) -&gt; Scooter | None:
    """Returns the closest Scooter to `point`."""
    if not scooters:
        return None

    for scooter in scooters:
        # XXX: Mutating an input is a side effect!
        scooter.distance = distance_between(scooter.location, point)

    closest_scooter = min(
        scooters,
        key=lambda scooter: scooter.distance
    )

    return closest_scooter
</textarea>
<pre class="cm-s-friendship-bracelet"></pre>

<p>This one’s <strong>super</strong> impure:</p>

<textarea class="hidden">
def notify_closest_scooter(
    conn: DatabaseConnection, point: Point
) -&gt; None:
    """Sends the user an email about the closest scooter to `point`."""

    # XXX: Reading from the database is a side effect!
    scooters = conn.get_some_scooters_near_point(point)

    if not scooters:
        return

    distances = [
        distance_between(scooter.location, point)
        for scooter in scooters
    ]

    closest_scooter, smallest_distance = min(
        zip(scooters, distances),
        key=lambda scooter, distance: distance
    )

    # XXX: Reading from a global variable violates rule 1!
    email = REQUEST["user_email"]

    # XXX: Sending an email is a side effect!
    send_closest_scooter_email_to_user(email, closest_scooter)
</textarea>
<pre class="cm-s-friendship-bracelet"></pre>

<h2 id="primary-benefit">Primary Benefit</h2>

<p>We have to put away some our tools when we write pure functions: we can’t read from the database, we can’t check what time it is, we can’t pull an API key from a global config object. What do we get in return?</p>

<p>The primary benefit of pure functions is that they are <strong>simple enough to fit into your head</strong>. In order to understand what a pure function does, you just need to look at these things:</p>

<ul>
  <li>What are the function’s inputs?</li>
  <li>What are the function’s outputs?</li>
</ul>

<p>By contrast, here are <em>some of</em> the things that you need to think about when you’re reading an impure function:</p>

<ul>
  <li>What are the function’s inputs?
    <ul>
      <li>When the function has finished running, what state will the inputs be in?</li>
      <li>Will some of the inputs have been mutated? Which ones?</li>
      <li>Will the inputs be mutated <em>every</em> time the function runs, or only <em>sometimes</em>?</li>
    </ul>
  </li>
  <li>What are the function’s outputs? Does it have any?</li>
  <li>What global variables does the function read from?
    <ul>
      <li>Have those global variables been initialized the way that we expect by the time that this function is called?</li>
      <li>What happens if they haven’t?</li>
    </ul>
  </li>
  <li>What global variables does the function <em>write to</em>?
    <ul>
      <li>How does that affect the other parts of the program that read those variables?</li>
    </ul>
  </li>
  <li>What if the database is unreachable?</li>
  <li>What if the API we’re calling is down?</li>
  <li>What day of the week is it?</li>
  <li>What is the phase of the moon as seen from Mars?
    <ul>
      <li><em>Which</em> moon?</li>
    </ul>
  </li>
</ul>

<p>When working with pure functions, you can think about the function in isolation and don’t have to worry about fitting the rest of the program into your head. I’ve heard this described as “<strong>local reasoning</strong>” (which pure functions enable you to do), as opposed to “global reasoning” (which impure code <em>forces</em> you to do).</p>

<h2 id="secondary-benefits">Secondary Benefits</h2>

<p>As if that weren’t enough, you also get these things for free:</p>

<ul>
  <li>Pure functions are safe to <strong>cache</strong>, since the same inputs always give the same outputs.</li>
  <li>Pure functions are safe to <strong>parallelize</strong>, since they don’t mutate anything.</li>
  <li>Pure functions are trivial to <strong>test</strong>, since you don’t need to mock anything.</li>
</ul>

<p>Let’s zoom in on that last bullet point, because the difference is really unbelievable. Here’s a test for the pure function I showed you earlier:</p>

<textarea class="hidden">
import test_fixtures

def test_find_closest_scooter():
    scooters = [
        test_fixtures.SCOOTER_IN_MIDDLE_OF_OCEAN,
        test_fixtures.SCOOTER_IN_SOUTHEAST_PORTLAND,
        test_fixtures.SCOOTER_IN_TORONTO_CANADA
    ]

    point = test_fixtures.DOWNTOWN_PORTLAND

    assert_equal(
        find_closest_scooter(scooters, point),
        test_fixtures.SCOOTER_IN_SOUTHEAST_PORTLAND
    )
</textarea>
<pre class="cm-s-friendship-bracelet"></pre>

<p>Here’s a test for the one of the impure functions:</p>

<textarea class="hidden">
from mock import patch

import test_fixtures
from scooters import notify

@patch.object(
    notify,
    "REQUEST",
    {"user_email": "jrheard@zombo.com"}
)
@patch.object(
    notify,
    "send_closest_scooter_email_to_user"
)
def test_notify_closest_scooter(send_email_mock, _request_mock):
    conn = test_fixtures.get_database_connection()

    scooters = [
        test_fixtures.SCOOTER_IN_MIDDLE_OF_OCEAN,
        test_fixtures.SCOOTER_IN_SOUTHEAST_PORTLAND,
        test_fixtures.SCOOTER_IN_TORONTO_CANADA
    ]

    point = test_fixtures.DOWNTOWN_PORTLAND

    with patch.object(
        conn,
        "get_some_scooters_near_point",
        return_value=scooters
    ):
        notify_closest_scooter(conn, point)

    send_email_mock.assert_called_once_with(
        "jrheard@zombo.com",
        test_fixtures.SCOOTER_IN_SOUTHEAST_PORTLAND
    )
</textarea>
<pre class="cm-s-friendship-bracelet"></pre>

<p>Which of these two worlds would you rather live in?</p>

<h2 id="general-advice">General Advice</h2>

<p>It’s easiest to write pure functions when you’re working with “<a href="https://blog.jrheard.com/book-report-architecture-patterns-python#value-objects">plain data</a>,” i.e. stuff that doesn’t have an active connection to the database. You can still make a function pure even if it’s operating on database models, though: as long as your function follows the two rules we talked about earlier, it’s pure!</p>

<p>I’ll bet that a lot of functions in your codebase are just one or two tweaks away from purity. As you get in the habit of looking for side effects, you’ll get better at identifying them and eliminating them. For example: does your function <em>really</em> need to modify its inputs and return <code class="language-plaintext highlighter-rouge">None</code>? What if it left its inputs unmodified and returned a value instead?</p>

<p>Of course, not <em>every</em> side effect can be removed. We write and run programs because they do stuff! For now, just focus on finding and eliminating the side effects that <strong>don’t need to happen</strong> (and the ones that don’t need to happen in <strong>this specific function</strong>). Next time we’ll talk about how to handle the side effects that remain!</p>

<h2 id="appendix-smells-to-watch-out-for">Appendix: Smells To Watch Out For</h2>

<ul>
  <li>If a function takes no inputs, it’s probably impure.</li>
  <li>If a function has no output, it’s probably impure.</li>
  <li>If a function is async, it’s probably impure.</li>
  <li>If you need to use mocks when testing a function, it’s probably impure.</li>
</ul>

<h2 id="references">References</h2>
<ul>
  <li><a href="https://www.youtube.com/watch?v=PBQN62oUnN8">Hoist Your I/O</a></li>
  <li><a href="https://www.youtube.com/watch?v=P1vES9AgfC4">Functional Core, Imperative Shell</a> (Scott Wlaschin version)</li>
  <li><a href="https://www.youtube.com/watch?v=vK1DazRK_a0&amp;t=2368s">This refactoring exercise</a> from “Solving Problems the Clojure Way” - I love the visualization technique the presenter uses, it makes it really easy to follow the side effects as they get moved or eliminated.</li>
  <li><a href="https://archive.is/zPtaC">Functional Programming in C++</a> (by John Carmack!!)</li>
</ul>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>Edsger Dijkstra: “The computing scientist’s main challenge is not to get confused by the complexities of his own making.” Steve McConnell: “Managing complexity is the most important technical topic in software development.” Ben Moseley and Peter Marks: “Complexity is the single major difficulty in the successful development of large-scale software systems.” Dr. Pamela Zave: “The purpose of software engineering is to control complexity, not to create it.” Bruce Eckel: “Programming is about managing complexity: the complexity of the problem, laid upon the complexity of the machine. Because of this complexity, most of our programming projects fail.” <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

</div>


<div class="message">
	
	<p>If you've found an error or have a suggestion, please open an issue or pull request on <a
			href="https://github.com/jrheard/blog">GitHub</a>.</p>
</div>


<script src="/assets/js/codemirror.js?v=2024-08-31 12:48:16 -0700"></script>
<script src="/assets/js/codemirror_python.js?v=2024-08-31 12:48:16 -0700"></script>
<script src="/assets/js/codemirror_runmode.js?v=2024-08-31 12:48:16 -0700"></script>
<script>
	var textAreas = document.getElementsByTagName("textarea");
	var pres = document.querySelectorAll("pre.cm-s-friendship-bracelet");

	for (var i = 0; i < textAreas.length; i++) {
		CodeMirror.runMode(textAreas[i].value, "python", pres[i]);
	}

	window.klipse_settings = {
		selector_eval_python_client: '.py',
		codemirror_options_in: {
			theme: "friendship-bracelet"
		},
		codemirror_options_out: {
			theme: "friendship-bracelet"
		}
	};
</script>
<script src="/assets/js/klipse.min.js?v=2024-08-31 12:48:16 -0700"></script>



    </div>
  </div>

  <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  <script>
    (function (document) {
      var toggle = document.querySelector('.sidebar-toggle');
      var sidebar = document.querySelector('#sidebar');
      var checkbox = document.querySelector('#sidebar-checkbox');

      document.addEventListener('click', function (e) {
        var target = e.target;

        if (!checkbox.checked ||
          sidebar.contains(target) ||
          (target === checkbox || target === toggle)) return;

        checkbox.checked = false;
      }, false);
    })(document);
  </script>



</body>

</html>
